name: Run Selenium + Behave Tests

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ----- Install Google Chrome -----
      - name: Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg unzip
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      # ----- Install ChromeDriver -----
      - name: Install ChromeDriver
        run: |
          CHROME_VERSION=$(google-chrome --version | cut -d " " -f 3 | cut -d "." -f 1)
          DRIVER_VERSION=$(wget -qO- "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
          wget -q "https://chromedriver.storage.googleapis.com/${DRIVER_VERSION}/chromedriver_linux64.zip"
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

      # ----- Install Python deps -----
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest behave selenium pytest-bdd requests

          # OPTIONAL: install your own project deps
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # ----- Debug -----
      - name: Show Chrome versions
        run: |
          google-chrome --version
          chromedriver --version

      # ----- Run Pytest tests -----
      - name: Run pytest test suite
        run: |
          echo "Running pytest tests"
          pytest -vv

      # ----- Run Behave tests -----
      - name: Run behave tests
        run: |
          echo "Running behave BDD tests"
          behave

